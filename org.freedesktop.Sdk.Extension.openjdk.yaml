---
id: org.freedesktop.Sdk.Extension.openjdk
branch: '22.08'
runtime: org.freedesktop.Sdk
runtime-version: '22.08'
build-extension: true
sdk: org.freedesktop.Sdk
separate-locales: false
appstream-compose: false
cleanup:
  - /share/info
  - /share/man
build-options:
  no-debuginfo: true
  strip: true
  prefix: /usr/lib/sdk/openjdk
  env:
    V: '1'
modules:
  - name: bootstrap_jdk
    buildsystem: simple
    cleanup:
      - '*'
    sources:
      - type: file
        only-arches:
          - x86_64
        url: https://fedorapeople.org/~mbooth/bootstrap_jdk/bootstrap-openjdk-16.0.1.0.9-1.rolling.fc32.x86_64.tar.bz2
        dest-filename: java-openjdk.tar.bz2
        sha512: 0084f99558a73788438df4fe62700584b41ee962d7de7bd322d8950207c88acfb3839c788def906926325f782ae86068315352dfc3b8c6d5375dec192cf3adeb
      - type: file
        only-arches:
          - aarch64
        url: https://fedorapeople.org/~mbooth/bootstrap_jdk/bootstrap-openjdk-16.0.1.0.9-1.rolling.fc32.aarch64.tar.bz2
        dest-filename: java-openjdk.tar.bz2
        sha512: a96e7fc8fdba6bb7a374e2f1f293aca567777b447ae30ac469ef2f38e2704dfa236b54d0d12d66c863f9058d79dd16e5fdffbf22ee1d5d8c7f6e744b3e86e3e4
    build-commands:
      - mkdir -p $FLATPAK_DEST/bootstrap-java
      - tar xf java-openjdk.tar.bz2 --strip-components=4 --directory=$FLATPAK_DEST/bootstrap-java
  - name: java
    buildsystem: autotools
    no-parallel-make: true
    config-opts:
      - --with-boot-jdk=/usr/lib/sdk/openjdk/bootstrap-java
      - --with-jvm-variants=server
      - --with-version-build=12
      - --with-version-pre=
      - --with-version-opt=
      - --with-vendor-version-string=21.9
      - --with-vendor-name=Flathub
      - --with-vendor-url=https://flathub.org
      - --with-vendor-bug-url=https://github.com/flathub/org.freedesktop.Sdk.Extension.openjdk/issues
      - --with-debug-level=release
      - --with-native-debug-symbols=internal
      - --enable-unlimited-crypto
      - --with-zlib=system
      - --with-libjpeg=system
      - --with-giflib=system
      - --with-libpng=system
      - --with-lcms=system
      - --with-harfbuzz=system
      - --with-stdc++lib=dynamic
      - --with-extra-cxxflags=-grecord-gcc-switches -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fstack-protector-strong -fasynchronous-unwind-tables -fstack-clash-protection
      - --with-extra-cflags=-grecord-gcc-switches -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fstack-protector-strong -fasynchronous-unwind-tables -fstack-clash-protection
      - --with-extra-ldflags=-Wl,-z,relro -Wl,-z,now -Wl,--as-needed
      - --disable-javac-server
      - --disable-warnings-as-errors
    make-args:
      - LOG=info
      - images
    post-install:
      - (cd $FLATPAK_DEST/jvm && ln -s openjdk-19.0.2 openjdk-19)
    sources:
      - type: archive
        url: https://codeload.github.com/openjdk/jdk19u/tar.gz/refs/tags/jdk-19.0.2%2B7
        sha512: f25f2fe1f835854bfbe0cfabde092aed3b883a5448b30be5a9e5788e79723bf2f6fca9d41383a99dcd980bed04e7f18cfef3d0f3044b245d32b5cb1ff351eefd
      - type: patch
        path: 0001-Avoid-requiring-pcsc-development-files-at-runtime.patch
      - type: shell
        commands:
          - chmod a+x configure
          - sed -i -e "s|@prefix@|$FLATPAK_DEST|" make/autoconf/spec.gmk.in
  - name: cacerts
    buildsystem: simple
    sources:
      - type: file
        path: extract_cacerts.sh
    build-commands:
      - ./extract_cacerts.sh $FLATPAK_DEST/jvm/openjdk-19
  - name: ant
    buildsystem: simple
    cleanup:
      - '*.bat'
      - '*.cmd'
    sources:
      - type: file
        url: https://dlcdn.apache.org//ant/binaries/apache-ant-1.9.16-bin.tar.gz
        dest-filename: apache-ant-bin.tar.gz
        sha512: 8d542a7a636a491e76170148881b6f413f4564aad1ab034f426bd946be93382001862bd6c60865aa2b57b39b9633e0181fe8997dd6323123aaf76b410ec4a366
    build-commands:
      - mkdir -p $FLATPAK_DEST/ant
      - tar xf apache-ant-bin.tar.gz --strip-components=1 --directory=$FLATPAK_DEST/ant
      - ln -s $FLATPAK_DEST/ant/bin/ant $FLATPAK_DEST/bin
  - name: maven
    buildsystem: simple
    cleanup:
      - '*.bat'
      - '*.cmd'
    sources:
      - type: file
        url: https://dlcdn.apache.org/maven/maven-3/3.9.1/binaries/apache-maven-3.9.1-bin.tar.gz
        dest-filename: apache-maven-bin.tar.gz
        sha256: 0869a4f71238e3eeec21051d062cfd915d34abe905c9bfebf94cd34578db0be7
    build-commands:
      - mkdir -p $FLATPAK_DEST/maven
      - tar xf apache-maven-bin.tar.gz --strip-components=1 --exclude=jansi-native --directory=$FLATPAK_DEST/maven
      - ln -s $FLATPAK_DEST/maven/bin/mvn $FLATPAK_DEST/maven/bin/mvnDebug $FLATPAK_DEST/bin
  - name: gradle
    buildsystem: simple
    cleanup:
      - '*.bat'
    sources:
      - type: file
        url: https://downloads.gradle-dn.com/distributions/gradle-8.0.2-bin.zip
        dest-filename: gradle-bin.zip
        sha256: ff7bf6a86f09b9b2c40bb8f48b25fc19cf2b2664fd1d220cd7ab833ec758d0d7
    build-commands:
      - unzip -q gradle-bin.zip -d $FLATPAK_DEST
      - mv $FLATPAK_DEST/gradle-* $FLATPAK_DEST/gradle
      - ln -s $FLATPAK_DEST/gradle/bin/gradle $FLATPAK_DEST/bin
  - name: scripts
    buildsystem: simple
    sources:
      - type: script
        commands:
          - mkdir -p /app/jre/bin
          - cd /usr/lib/sdk/openjdk/jvm/openjdk-19
          - cp -ra conf lib release /app/jre/
          - rm /app/jre/lib/src.zip /app/jre/lib/ct.sym
          - cp -ra bin/{java,keytool,rmiregistry} /app/jre/bin
        dest-filename: install.sh
      - type: script
        commands:
          - mkdir -p /app/jdk/
          - cd /usr/lib/sdk/openjdk/jvm/openjdk-19
          - cp -ra bin conf include jmods lib release /app/jdk/
        dest-filename: installjdk.sh
      - type: script
        commands:
          - export JAVA_HOME=/usr/lib/sdk/openjdk/jvm/openjdk-19
          - export PATH=$PATH:/usr/lib/sdk/openjdk/bin
        dest-filename: enable.sh
    build-commands:
      - cp enable.sh install.sh installjdk.sh /usr/lib/sdk/openjdk/
  - name: appdata
    buildsystem: simple
    sources:
      - type: file
        path: org.freedesktop.Sdk.Extension.openjdk.appdata.xml
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/share/metainfo
      - cp org.freedesktop.Sdk.Extension.openjdk.appdata.xml ${FLATPAK_DEST}/share/metainfo
      - appstream-compose --basename=org.freedesktop.Sdk.Extension.openjdk --prefix=${FLATPAK_DEST} --origin=flatpak org.freedesktop.Sdk.Extension.openjdk
